# Feature Spec: Agent Traces & Debugging

## 1. Context
- **Goal:** Provide visibility into the Socratic Agent's internal state machine (LangGraph) to understand exchanges, income, outcomes, and reasoning steps.
- **Target Audience:** Developers (the User). This is an internal tool, not for end-users.
- **Problem:** The agent is currently a "black box." We see the input and the final output, but not the intermediate `examine` (search) or `aporia` (reasoning) steps.

## 2. Requirements

### Functional
1.  **Trace Storage:**
    -   Capture *every* step of the LangGraph execution (Input -> Examine -> Aporia -> Output).
    -   Store the full state at each step: `messages`, `vertexSearchCount`, `ragCitations`.
    -   Persistence: Store in Firestore under a structured schema.
2.  **Dashboard UI (`/traces`):**
    -   List recent Agent Runs (threads).
    -   Show metadata: Timestamp, User Email (if avail), Last Message Preview.
3.  **Detail UI (`/traces/[threadId]`):**
    -   Visual timeline of the agent's execution.
    -   Collapsible sections for each node (`Examine`, `Aporia`).
    -   Raw JSON view for inspecting state.

### Technical Constraints
-   **Storage:** Firestore.
-   **Performance:** Tracing adds latency. Acceptable for this debug feature.
-   **Privacy:** Trace data is for internal use only.

## 3. Technical Implementation

### Data Model (Firestore)

We will upgrade `FirestoreSaver` to support standard LangGraph checkpointing.

**Collection: `threads`**
-   `id`: `thread_id` (UUID)
-   `created_at`: timestamp
-   `metadata`: arbitrary metadata (e.g. user_id)

**Collection: `threads/{thread_id}/checkpoints`**
-   `id`: `checkpoint_id` (UUID generated by LangGraph)
-   `thread_id`: string ref
-   `checkpoint`: JSON blob (The `AgentState`)
-   `metadata`: JSON blob (Step, source node, writes)
-   `parent_checkpoint_id`: string (for the DAG)

### API Changes
-   **`api/chat/route.ts`**:
    -   Must generate or accept a `threadId`.
    -   Must instantiate the `app` with `checkpointer: new FirestoreSaver()`.
    -   Must pass `{ configurable: { thread_id: ... } }` to `app.invoke`.

### UI Components
1.  **Entry Point**: Add a "Traces" link in the `LogicSidebar` (bottom footer area) or a dev-only floating toggle.
2.  **`TraceList`**: Table of threads at `/traces`.
3.  **`TraceTimeline`**: Vertical list of steps at `/traces/[id]`.
    -   *Step Item*: Shows Node Name (e.g. "Examine"), Status, and Duration.
    -   *Expanded*: Shows `state.ragCitations`, `state.messages`, etc.

## 4. Work Plan
1.  **Backend**: Upgrade `FirestoreSaver` to save historical checkpoints.
2.  **Backend**: Update `api/chat/route.ts` to use a persistent `thread_id`.
3.  **Frontend**: Build `/traces` page (list view).
4.  **Frontend**: Build `/traces/[id]` page (detail view).
